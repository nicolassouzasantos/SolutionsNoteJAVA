
DECLARE
    v_count INTEGER;
BEGIN
    -- Guarantee PATIO exists even if this environment was baselined before V1 ran
    SELECT COUNT(*)
      INTO v_count
      FROM USER_TABLES
     WHERE TABLE_NAME = 'PATIO';

    IF v_count = 0 THEN
        EXECUTE IMMEDIATE q'[
            CREATE TABLE PATIO (
                ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
                NOME VARCHAR2(255) NOT NULL,
                ENDERECO VARCHAR2(255)
            )
        ]';
    END IF;

    -- Create AUTOMOVEL table if necessary
    SELECT COUNT(*)
      INTO v_count
      FROM USER_TABLES
     WHERE TABLE_NAME = 'AUTOMOVEL';

    IF v_count = 0 THEN
        EXECUTE IMMEDIATE q'[
            CREATE TABLE AUTOMOVEL (
                ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
                PLACA VARCHAR2(20) NOT NULL,
                CHASSI VARCHAR2(50) NOT NULL,
                TIPO VARCHAR2(100) NOT NULL,
                COR VARCHAR2(50),
                LOCALIZACAO_NO_PATIO VARCHAR2(150),
                COMENTARIOS CLOB,
                PATIO_ID NUMBER
            )
        ]';
    END IF;

    -- Ensure foreign key is present
    SELECT COUNT(*)
      INTO v_count
      FROM USER_CONSTRAINTS
     WHERE CONSTRAINT_NAME = 'FK_AUTOMOVEL_PATIO'
       AND TABLE_NAME = 'AUTOMOVEL';

    IF v_count = 0 THEN
        EXECUTE IMMEDIATE q'[
            ALTER TABLE AUTOMOVEL
                ADD CONSTRAINT FK_AUTOMOVEL_PATIO FOREIGN KEY (PATIO_ID) REFERENCES PATIO (ID)
        ]';
    END IF;

    -- Ensure indexes exist
    SELECT COUNT(*)
      INTO v_count
      FROM USER_INDEXES
     WHERE INDEX_NAME = 'IDX_AUTOMOVEL_PLACA';

    IF v_count = 0 THEN
        EXECUTE IMMEDIATE q'[
            CREATE INDEX IDX_AUTOMOVEL_PLACA ON AUTOMOVEL (PLACA)
        ]';
    END IF;

    SELECT COUNT(*)
      INTO v_count
      FROM USER_INDEXES
     WHERE INDEX_NAME = 'IDX_AUTOMOVEL_TIPO';

    IF v_count = 0 THEN
        EXECUTE IMMEDIATE q'[
            CREATE INDEX IDX_AUTOMOVEL_TIPO ON AUTOMOVEL (TIPO)
        ]';
    END IF;
END;
/

CREATE TABLE AUTOMOVEL (
    ID NUMBER GENERATED BY DEFAULT ON NULL AS IDENTITY PRIMARY KEY,
    PLACA VARCHAR2(20) NOT NULL,
    CHASSI VARCHAR2(50) NOT NULL,
    TIPO VARCHAR2(100) NOT NULL,
    COR VARCHAR2(50),
    LOCALIZACAO_NO_PATIO VARCHAR2(150),
    COMENTARIOS CLOB,
    PATIO_ID NUMBER,
    CONSTRAINT FK_AUTOMOVEL_PATIO FOREIGN KEY (PATIO_ID) REFERENCES PATIO (ID)
);

CREATE INDEX IDX_AUTOMOVEL_PLACA ON AUTOMOVEL (PLACA);
CREATE INDEX IDX_AUTOMOVEL_TIPO ON AUTOMOVEL (TIPO);
